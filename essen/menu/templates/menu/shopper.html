<!DOCTYPE html>

{% extends 'essen/base.html' %}

{% load static %}
{% load menu_extras %}
{% load recipe_tags %}

{% block script %}
<style type="text/css">
    table#shopper td {
        vertical-align: middle;
    }

    .table tr.striped {
        background-color: #f9f9f9;
    }

    .table > tbody > tr.ghost > td {
        border-top: 0;
        padding: 0;
    }

    .sub-table {
        margin-bottom: 0;
        border-bottom: 0;
        background-color: rgb(255, 248, 241) !important;
    }

    .sub-table > tbody > tr > td:first-child { padding-left: 20px; }

    .sub-table > tbody > tr > td:nth-child(2) { width: 30%; }
    .sub-table > tbody > tr > td.magnitude { width: 8%; text-align: right; padding-right: 4px; }
    .sub-table > tbody > tr > td.unit { width: 12%; text-align: left; padding-left: 4px; }

    .quantity-table { width: 100%; }
    .quantity-table td.magnitude { width: 40%; text-align: right; padding-right: 4px; }
    .quantity-table td.unit { width: 60%; text-align: left; padding-left: 4px; }
</style>

<script type="text/javascript">
    // Auto collapse table
    $(function() {
        $('#ingredients [data-toggle="collapse"]').click(function() {
            $('#ingredients .collapse.in').collapse('hide');
        });
    });

    // Change units when user clicks on the unit or magnitude cell.
    $(function() {
        $("tr.quantity > td.unit, tr.quantity > td.magnitude").click(function() {
            let row = $(this).parent();
            let currentIndex = row.data("index");
            let quantities = row.data("quantities") ;
            
            if (quantities.length == 0) return;
            if (currentIndex === undefined) {
                // Set the initial index
                if (quantities.length > 1) {
                    let initialUnit = $(".unit", row).text();
                    if (quantities[0][1] == initialUnit) {
                        currentIndex = 0;
                    } else {
                        currentIndex = -1;
                    }
                }
            }

            let newIndex = (currentIndex + 1) % quantities.length;
            row.data("index", newIndex);

            $(".magnitude", row).text(quantities[newIndex][0]);
            $(".unit", row).text(quantities[newIndex][1]);
        });
    });
</script>
{% endblock %}

{% block content %}

<div class="text-center">
{% if filter_date %}
    <h2>Required ingredients after {{after}}</h2>
{% else %}
    <h1>Shopping List</h1>
    <h3><small>{{menu.notes}}</small></h3>
{% endif %}
</div>

<div class="container">
    <div class="row">
        <div class="col-sm-2"></div>
        <div class="col-sm-8" id="ingredients">
            <table class="table" id="shopper">
                <colgroup>
                    <col style="width: auto">
                    <col style="width: 25%">
                </colgroup>

            {% for c_ingredient in ingredients %}
                {% if forloop.counter|divisibleby:2 %}<tr>{% else %}<tr class="striped">{% endif %}
                    <td data-toggle="collapse" data-target="#collapse_{{forloop.counter}}">{{ c_ingredient.name }}</td>
                    <td>
                        <table class="quantity-table"> 
                        {% for q in c_ingredient.quantities %}
                            <tr class="quantity" data-quantities='{% data_quantities_str quantity=q %}'>
                                <td class="magnitude noselect">{{ q.magnitude_str }}</td>
                                <td class="unit noselect">{{ q.unit_str }}</td>
                            </tr>
                        {% endfor %}
                        </table>
                    </td>
                </tr>
                <tr class="ghost">
                    <td colspan="2">
                        <div id="collapse_{{forloop.counter}}" class="collapse">
                            <table class="table sub-table">
                            {% for ingredient in c_ingredient.ingredients %}
                                <tr class="quantity" data-quantities='{% data_quantities_str ingredient=ingredient %}'>
                                    <td><a href="{% url 'menu:display_meal' ingredient.recipe.meal.id %}#recipe_{{ingredient.recipe.id}}">{{ ingredient.recipe.name }}</a></td>
                                    <td>{{ ingredient.name }}</td>
                                    <td class="magnitude noselect">{{ ingredient.magnitude_str }}</td>
                                    <td class="unit noselect">{{ ingredient.unit_str }}</td>
                                </tr>
                            {% endfor %}
                            </table>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </table>

        </div>
    </div>
</div>
{% endblock %}

</html>